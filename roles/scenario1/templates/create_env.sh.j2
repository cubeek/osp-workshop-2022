#!/bin/bash

source {{ overcloudrc_file }}

# Create Cirros image
curl -L http://download.cirros-cloud.net/0.5.2/cirros-0.5.2-x86_64-disk.img > cirros-0.5.2-x86_64-disk.img
openstack image create cirros --file cirros-0.5.2-x86_64-disk.img --disk-format qcow2 --container-format bare --public

openstack network create private-network

openstack subnet create --network private-network private-subnet --subnet-range 192.168.10.0/24

openstack router create private-router

openstack router set --enable-snat --external-gateway {{ public_network }} private-router
openstack router add subnet private-router private-subnet

openstack flavor create m1.tiny --disk 1 --vcpus 1 --ram 64
openstack flavor create m1.medium --disk 10 --vcpus 1 --ram 512

openstack security group create sg1

openstack keypair create klicek > ~/klicek.pem
chmod 0600 ~/klicek.pem

openstack server create --flavor m1.medium --image cirros --nic net-id=private-network --key-name klicek --security-group sg1 vm-private-network --wait
openstack server show vm-private-network | grep -q "status.*ACTIVE"

if [ $? -ne 0 ]; then
    exit 1
fi

port_id=$(openstack port list --server vm-private-network -c ID -f value | head)
fip=$(openstack floating ip create --port $port_id {{ public_network }} | grep floating_ip_address | awk '{ print $4 }')

echo "$fip"
